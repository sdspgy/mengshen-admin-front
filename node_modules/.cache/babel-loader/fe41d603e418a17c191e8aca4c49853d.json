{"remainingRequest":"/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/node_modules/thread-loader/dist/cjs.js!/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/node_modules/babel-loader/lib/index.js!/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/src/views/game/cdkey/cdkey.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/src/views/game/cdkey/cdkey.vue","mtime":1574132205000},{"path":"/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/hoolai/Documents/tyz/workspace-ws/baobao-admin-front/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { getOperation as _getOperation, getItemList as _getItemList, addcdkey as _addcdkey, getCDkeys, getUseUsers, exportExcel, deleteCDkey as _deleteCDkey } from \"@/api/index\";\nimport util from \"../../../libs/util\";\nexport default {\n  name: 'cdkey',\n  mounted: function mounted() {\n    this.getItemList();\n    this.getOperation();\n  },\n  data: function data() {\n    var _this = this;\n\n    return {\n      columnsWithOperation: [{\n        type: \"index\",\n        width: 60,\n        align: \"center\"\n      }, {\n        title: \"生成时间\",\n        key: \"createTime\",\n        width: 180,\n        align: \"center\",\n        render: function render(h, params) {\n          return h(\"div\", util.Time2DefaultFormat(params.row.createTime));\n        }\n      }, {\n        title: \"开始时间\",\n        key: \"startTime\",\n        width: 180,\n        align: \"center\",\n        render: function render(h, params) {\n          return h(\"div\", util.Time2DefaultFormat(params.row.startTime));\n        }\n      }, {\n        title: \"结束时间\",\n        key: \"endTime\",\n        width: 180,\n        align: \"center\",\n        render: function render(h, params) {\n          return h(\"div\", util.Time2DefaultFormat(params.row.endTime));\n        }\n      }, {\n        title: \"道具内容\",\n        key: \"rewards\",\n        width: 200,\n        align: \"center\",\n        render: function render(h, params) {\n          return h(\"div\", _this.formatReward(params.row.rewards));\n        }\n      }, {\n        title: \"生成数量\",\n        key: \"createNum\",\n        width: 120,\n        align: \"center\",\n        render: function render(h, params) {\n          var discardNum = \"\";\n\n          if (params.row.discardNum && params.row.discardNum > 0) {\n            discardNum = \"(-\".concat(params.row.discardNum, \")\");\n          }\n\n          return h(\"div\", params.row.createNum + discardNum);\n        }\n      }, {\n        title: \"可使用次数\",\n        key: \"totalNum\",\n        width: 120,\n        align: \"center\"\n      }, {\n        title: \"渠道\",\n        key: \"channel\",\n        width: 120,\n        align: \"center\"\n      }, {\n        title: \"操作\",\n        key: \"action\",\n        width: 100,\n        align: \"center\",\n        render: function render(h, params) {\n          return h(\"div\", [h(\"Button\", {\n            props: {\n              type: \"primary\",\n              size: \"small\"\n            },\n            on: {\n              click: function click() {\n                _this.openCDkeyDialog(params.row);\n              }\n            }\n          }, \"查看\")]);\n        }\n      }],\n      columnsWithRewards: [{\n        type: \"index\",\n        width: 60,\n        align: \"center\"\n      }, {\n        title: \"道具ID\",\n        key: \"id\",\n        width: 120,\n        align: \"center\"\n      }, {\n        title: \"道具名称\",\n        key: \"id\",\n        width: 120,\n        align: \"center\",\n        render: function render(h, params) {\n          return h(\"div\", _this.formatItem(params.row.id));\n        }\n      }, {\n        title: \"道具数量\",\n        key: \"num\",\n        width: 120,\n        align: \"center\"\n      }, {\n        title: \"操作\",\n        key: \"action\",\n        width: 100,\n        align: \"center\",\n        render: function render(h, params) {\n          return h(\"div\", [h(\"Button\", {\n            props: {\n              type: \"error\",\n              size: \"small\"\n            },\n            on: {\n              click: function click() {\n                _this.delReward(params.index);\n              }\n            }\n          }, \"删除\")]);\n        }\n      }],\n      columnsWithCDkey: [{\n        type: \"index\",\n        width: 60,\n        align: \"center\"\n      }, {\n        title: \"兑换码ID\",\n        key: \"key\",\n        width: 110,\n        align: \"center\"\n      }, {\n        title: \"领取状态\",\n        key: \"useNum\",\n        width: 120,\n        align: \"center\",\n        render: function render(h, params) {\n          return h(\"div\", params.row.useNum > 0 ? '已领取' : '未领取');\n        }\n      }, {\n        title: \"领取时间\",\n        key: \"fistUseTime\",\n        width: 120,\n        align: \"center\",\n        render: function render(h, params) {\n          return h(\"div\", params.row.fistUseTime ? util.Time2DefaultFormat(params.row.fistUseTime) : '未领取');\n        }\n      }, {\n        title: \"用户ID\",\n        key: \"fistUsrUserId\",\n        width: 120,\n        align: \"center\"\n      }, {\n        title: \"已使用次数\",\n        key: \"useNum\",\n        width: 110,\n        align: \"center\"\n      }, {\n        title: \"操作\",\n        key: \"action\",\n        width: 200,\n        align: \"center\",\n        render: function render(h, params) {\n          var deleteButton = '';\n\n          if (_this.$route.meta.permTypes.includes('delete')) {\n            deleteButton = h(\"Button\", {\n              props: {\n                type: \"error\",\n                size: \"small\"\n              },\n              on: {\n                click: function click() {\n                  _this.deleteCDkey(params.row);\n                }\n              }\n            }, \"删除\");\n          }\n\n          return h(\"div\", [h(\"Button\", {\n            props: {\n              type: \"primary\",\n              size: \"small\"\n            },\n            on: {\n              click: function click() {\n                _this.openSeeUserDialog(params.row.key);\n              }\n            }\n          }, \"使用详情\"), deleteButton]);\n        }\n      }],\n      columnsWithUsers: [{\n        type: \"index\",\n        width: 60,\n        align: \"center\"\n      }, {\n        title: \"兑换码\",\n        key: \"key\",\n        width: 110,\n        align: \"center\"\n      }, {\n        title: \"用户ID\",\n        key: \"userId\",\n        width: 110,\n        align: \"center\"\n      }, {\n        title: \"领取时间\",\n        key: \"useTime\",\n        width: 110,\n        align: \"center\",\n        render: function render(h, params) {\n          return h(\"div\", util.Time2DefaultFormat(params.row.useTime));\n        }\n      }],\n\n      /** 添加礼包对话框显示 */\n      dialogFormVisible: false,\n\n      /** 礼包查看操作对话框显示 */\n      dialogSeeVisible: false,\n\n      /** 查看所有用户数据 */\n      dialogSeeUserVisible: false,\n      dialogExportExcelVisible: false,\n      downloadDataLimit: 50000,\n      formLabelWidth: '120px',\n      page: {\n        operation: {\n          per_page: 10,\n          cur_page: 1,\n          total: 0,\n          channel: ''\n        },\n        cdkey: {\n          pagesize: 10,\n          currentpage: 1,\n          total: 0,\n          currentOperation: {}\n        },\n        user: {\n          pagesize: 10,\n          currentpage: 1,\n          total: 0,\n          key: ''\n        }\n      },\n\n      /** 根据筛选条件后所有礼包数据 */\n      operations: [],\n\n      /** 查看礼包，当前礼包内的所有cdkey数据 */\n      cdkeys: [],\n\n      /** 查看cdkey下所有使用用户 */\n      users: [],\n\n      /** 提交到后端的添加数据 */\n      isDIY: false,\n      form: {\n        diyCdk: '',\n        formTime: [],\n        rewards: [],\n        createNum: '',\n        totalNum: '',\n        channel: ''\n      },\n\n      /** 道具下拉框，需要请求后端获取道具数据 */\n      itemType: 0,\n      itemList: [],\n      itemLists: [],\n      itemData: {\n        itemList: {},\n        decoShopList: {},\n        staffList: {},\n        goodList: {}\n      },\n      itemTypes: [{\n        type: 0,\n        label: '货币'\n      }, {\n        type: 1,\n        label: '道具'\n      }, {\n        type: 2,\n        label: '家具'\n      }, {\n        type: 3,\n        label: '员工'\n      }, {\n        type: 4,\n        label: '货物'\n      }],\n      addItemId: '',\n      addItemNum: '',\n\n      /** 时间选择禁止选择当天前的日期 */\n      expireTimeOption: {\n        disabledDate: function disabledDate(date) {\n          return date.getTime() < new Date(new Date().toLocaleDateString()).getTime();\n        }\n      }\n    };\n  },\n  methods: {\n    getItemList: function getItemList() {\n      var _this2 = this;\n\n      _getItemList().then(function (res) {\n        if (res.status === 200) {\n          _this2.itemData.decoShopList = res.data.decoShopList;\n          _this2.itemData.itemList = res.data.itemList;\n          _this2.itemData.staffList = res.data.staffList;\n          _this2.itemData.goodList = res.data.goodList;\n          /** 显示奖励时用 */\n\n          _this2.itemLists = [{\n            id: -1,\n            name: '经验'\n          }, {\n            id: -2,\n            name: '黄金'\n          }, {\n            id: -3,\n            name: '钻石'\n          }];\n          res.data.decoShopList.forEach(function (obj) {\n            _this2.itemLists.push({\n              id: obj.id,\n              name: obj.name\n            });\n          });\n          res.data.itemList.forEach(function (obj) {\n            _this2.itemLists.push({\n              id: obj.id,\n              name: obj.name\n            });\n          });\n          res.data.staffList.forEach(function (obj) {\n            _this2.itemLists.push({\n              id: obj.id,\n              name: obj.name\n            });\n          });\n          res.data.goodList.forEach(function (obj) {\n            _this2.itemLists.push({\n              id: obj.id,\n              name: obj.name\n            });\n          });\n        }\n      });\n    },\n    changeItemType: function changeItemType() {\n      this.itemList = [];\n      this.clearAddItem();\n\n      switch (this.itemType) {\n        case 0:\n          this.itemList.push({\n            id: -1,\n            name: '经验'\n          });\n          this.itemList.push({\n            id: -2,\n            name: '黄金'\n          });\n          this.itemList.push({\n            id: -3,\n            name: '钻石'\n          });\n          return;\n\n        case 1:\n          this.itemList = this.itemData.itemList;\n          return;\n\n        case 2:\n          this.itemList = this.itemData.decoShopList;\n          return;\n\n        case 3:\n          this.itemList = this.itemData.staffList;\n          return;\n\n        case 4:\n          this.itemList = this.itemData.goodList;\n      }\n    },\n    queryOperation: function queryOperation() {\n      this.page.operation.currentpage = 1;\n      this.getOperation();\n    },\n    getOperation: function getOperation() {\n      var _this3 = this;\n\n      _getOperation(this.page.operation).then(function (res) {\n        if (res.status === 200) {\n          _this3.operations = res.data.operations;\n          _this3.page.operation.total = res.data.total;\n        }\n      });\n    },\n    handleSizeChange: function handleSizeChange(value) {\n      this.page.operation.per_page = value;\n      this.getOperation();\n    },\n    handleCurrentChange: function handleCurrentChange(value) {\n      this.page.operation.cur_page = value;\n      this.getOperation();\n    },\n    handleCDkeySizeChange: function handleCDkeySizeChange(value) {\n      this.page.cdkey.pagesize = value;\n      this.getCDkey();\n    },\n    handleCDkeyCurrentChange: function handleCDkeyCurrentChange(value) {\n      this.page.cdkey.currentpage = value;\n      this.getCDkey();\n    },\n    handleUserSizeChange: function handleUserSizeChange(value) {\n      this.page.user.pagesize = value;\n      this.getUseUser();\n    },\n    handleUserCurrentChange: function handleUserCurrentChange(value) {\n      this.page.user.currentpage = value;\n      this.getUseUser();\n    },\n    openDialog: function openDialog() {\n      if (this.itemList.length <= 0) {\n        this.getItemList();\n      }\n\n      this.itemType = 0;\n      this.changeItemType();\n      this.form = {\n        diyCdk: '',\n        rewards: [],\n        createNum: '',\n        totalUseNum: '',\n        channel: '',\n        rewardStr: ''\n      };\n      this.dialogFormVisible = true;\n      this.isDIY = false;\n    },\n    openDialogWithDIY: function openDialogWithDIY() {\n      this.openDialog();\n      this.isDIY = true;\n    },\n    hideDialog: function hideDialog() {\n      this.dialogFormVisible = false;\n    },\n    addcdkey: function addcdkey() {\n      var _this4 = this;\n\n      if (!this.form.formTime) {\n        this.$Message.error('请选择时间');\n        return;\n      }\n\n      if (!this.form.rewards || this.form.rewards.length === 0) {\n        this.$Message.error('请添加道具');\n        return;\n      }\n\n      if (!this.form.channel) {\n        this.$Message.error('请输入渠道');\n        return;\n      }\n\n      if (!this.form.createNum) {\n        this.form.createNum = 1;\n      }\n\n      if (!this.form.totalNum) {\n        this.form.totalNum = 1;\n      }\n\n      if (this.isDIY && !this.form.diyCdk) {\n        this.$Message.error('请输入自定义兑换码');\n        return;\n      }\n\n      this.form.formTime.forEach(function (item, index) {\n        _this4.form.formTime[index] = item.getTime();\n      });\n      this.form.rewards.forEach(function (item, index) {\n        _this4.form.rewards[index] = item.id + ',' + item.num;\n      });\n      this.form.rewardStr = this.form.rewards.join(';');\n      this.form.isDiy = this.isDIY;\n      this.hideDialog();\n\n      _addcdkey(this.form).then(function (res) {\n        if (res.status === 200) {\n          if (res.data.error) {\n            _this4.$Message.error(res.data.error);\n\n            return;\n          }\n\n          if (res.data.insertFail) {\n            _this4.$Message.error('兑换码' + res.data.insertFail.slice(0, -1) + '已存在');\n          }\n\n          if (res.data.success > 0) {\n            _this4.$Message.success('成功生成' + res.data.success + '条CDkey');\n          }\n\n          _this4.getOperation();\n        }\n      });\n    },\n    addReward: function addReward() {\n      if (!this.addItemNum || !this.addItemId || this.addItemNum <= 0) {\n        this.$Message.error('请正确添加');\n        return;\n      }\n\n      this.form.rewards.push({\n        id: this.addItemId,\n        num: this.addItemNum\n      });\n      /** 合并相同id >> 暂时可以不用 */\n\n      var newArr = [];\n      this.form.rewards.forEach(function (el) {\n        var result = newArr.findIndex(function (ol) {\n          return el.id === ol.id;\n        });\n\n        if (result !== -1) {\n          newArr[result].num = newArr[result].num + el.num;\n        } else {\n          newArr.push(el);\n        }\n      });\n      this.form.rewards = newArr; // this.form.rewards.forEach(obj => {\n      //   const result = this.itemData.staffList.findIndex(ol => {\n      //     return obj.id === ol.id\n      //   })\n      //   if (result !== -1 && obj.num > 1) {\n      //     this.$message({\n      //       type: 'warning',\n      //       message: `员工${obj.id}的数量超过上限，已重置`\n      //     });\n      //     obj.num = 1;\n      //   }\n      // })\n\n      /** 合并相同id >> end */\n\n      this.clearAddItem();\n    },\n    clearAddItem: function clearAddItem() {\n      this.addItemId = '';\n      this.addItemNum = '';\n    },\n    clearRewards: function clearRewards() {\n      this.form.rewards = [];\n    },\n    delReward: function delReward(index) {\n      this.form.rewards.splice(index, 1);\n    },\n    openCDkeyDialog: function openCDkeyDialog(scopeRow) {\n      this.page.cdkey.currentOperation = scopeRow;\n      this.page.cdkey.currentpage = 1;\n      this.getCDkey();\n      this.dialogSeeVisible = true;\n    },\n    getCDkey: function getCDkey() {\n      var _this5 = this;\n\n      getCDkeys({\n        per_page: this.page.cdkey.pagesize,\n        cur_page: this.page.cdkey.currentpage,\n        operationId: this.page.cdkey.currentOperation.operationId\n      }).then(function (res) {\n        if (res.status === 200) {\n          _this5.page.cdkey.total = res.data.total;\n          _this5.cdkeys = res.data.cdkeys;\n        }\n      });\n    },\n    hideCDkeyDialog: function hideCDkeyDialog() {\n      this.dialogSeeVisible = false;\n      this.getOperation();\n    },\n    openSeeUserDialog: function openSeeUserDialog(key) {\n      this.page.user.key = key;\n      this.page.user.currentpage = 1;\n      this.getUseUser();\n      this.dialogSeeUserVisible = true;\n    },\n    deleteCDkey: function deleteCDkey(row) {\n      var _this6 = this;\n\n      if (row.useNum > 0) {\n        this.$Message.error('该条cdkey已被使用');\n        return;\n      }\n\n      this.$Modal.confirm({\n        title: \"确认删除\",\n        content: \"您确认要删除 \" + row.key + \" ?\",\n        loading: true,\n        onOk: function onOk() {\n          _deleteCDkey({\n            key: row.key\n          }).then(function (res) {\n            _this6.$Modal.remove();\n\n            if (res.status === 200) {\n              if (res.data.error) {\n                _this6.$Message.error(res.data.error);\n              } else {\n                _this6.$Message.success('成功删除' + res.data.success + '条CDkey');\n              }\n\n              _this6.getCDkey();\n            }\n          });\n        }\n      });\n    },\n    getUseUser: function getUseUser() {\n      var _this7 = this;\n\n      getUseUsers({\n        per_page: this.page.user.pagesize,\n        cur_page: this.page.user.currentpage,\n        key: this.page.user.key\n      }).then(function (res) {\n        if (res.status === 200) {\n          _this7.page.user.total = res.data.total;\n          _this7.users = res.data.users;\n        }\n      });\n    },\n    exportExcel: function exportExcel() {\n      if (this.page.cdkey.total > this.downloadDataLimit) {\n        this.dialogExportExcelVisible = true;\n        return;\n      }\n\n      this.getExportExcel(0, this.page.cdkey.total);\n    },\n    exportExcelInBatches: function exportExcelInBatches(n) {\n      this.getExportExcel((n - 1) * this.downloadDataLimit, this.downloadDataLimit);\n    },\n    getExportExcel: function getExportExcel(startIndex, pageSize) {\n      exportExcel({\n        operationId: this.page.cdkey.currentOperation.operationId,\n        startIndex: startIndex,\n        pageSize: pageSize\n      }).then(function (res) {\n        var url = window.URL.createObjectURL(new Blob([res.data]));\n        var link = document.createElement('a');\n        link.style.display = 'none';\n        link.href = url;\n        var fileName = res.headers['content-disposition'].split('filename=');\n        fileName[1] = util.Time2DefaultFormat(new Date().getTime()) + \".xlsx\";\n        link.setAttribute('download', fileName[1]);\n        document.body.appendChild(link);\n        link.click();\n      });\n    },\n    hideSeeUserDialog: function hideSeeUserDialog() {\n      this.dialogSeeUserVisible = false;\n    },\n    formatReward: function formatReward(rewardStr) {\n      var _this8 = this;\n\n      var rowElement = rewardStr.split(';');\n      var array = [];\n      rowElement.forEach(function (obj) {\n        var result = _this8.itemLists.findIndex(function (ol) {\n          return parseInt(obj.split(',')[0]) === ol.id;\n        });\n\n        if (result !== -1) {\n          array.push(_this8.itemLists[result].name + '*' + obj.split(',')[1]);\n        } else {\n          array.push(obj.split(',')[0] + '*' + obj.split(',')[1]);\n        }\n      });\n      return array.join(', ');\n    },\n    formatItem: function formatItem(id) {\n      var name = '';\n      this.itemLists.forEach(function (o) {\n        if (o.id === id) {\n          name = o.name;\n        }\n      });\n      return name;\n    }\n  }\n};",null]}